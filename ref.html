<script type="module">
  const url = new URL(location.href)
  let from = url.searchParams.get('installFrom')
  const commingFrom = document.referrer
  const taken = document.cookie.split(/; */).filter(x => x.endsWith('=cma')).map(x => x.split('=')[0])

  if (from === 'referrer' && commingFrom) {
    const { parseGithubURL } = await import('/clientmyadmin/shared/itty-github-parser.js')
    const r = await parseGithubURL(commingFrom)
    // generate subdomain
    const subdomain = r.repo + '-' + r.type === 'pull'
      ? r.branch.slice(0, 5)
      : r.branch.replaceAll('/', '-')
    // Set the filepath
    const path = r.filepath || location.pathname.slice(1)
    // Set the installFrom query string
    const installFrom = `gh/${r.user}/${r.repo}@${encodeURIComponent(r.branch)}`
    // Redirect to the new URL
    location.href = `https://${subdomain}.localwebcontainer.com/${path}?installFrom=${installFrom}`
  }

  if (from && from !== 'referrer') {
    // hash from using web crypto api
    const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(from))
    location.href = `https://${hash.slice(0, 5)}.localwebcontainer.com?installFrom=${from}`
  }
</script>